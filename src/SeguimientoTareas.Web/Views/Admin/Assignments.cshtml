@{
    ViewData["Title"] = "Gestión de Asignaciones";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-clipboard-list me-2"></i>Gestión de Asignaciones</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignmentModal" onclick="openCreateModal()">
            <i class="fas fa-plus me-2"></i>Nueva Asignación
        </button>
    </div>
</div>

<!-- Assignments Table -->
<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="assignmentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>Título</th>
                        <th>Asignado a</th>
                        <th>Plantilla</th>
                        <!-- Specialist column removed -->
                        <th>Fecha Inicio</th>
                        <th>Fecha Límite</th>
                        <th>Progreso</th>
                        <th width="100">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center">
                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" aria-labelledby="assignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignmentModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Nueva Asignación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="assignmentForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assignmentTitle" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="assignmentTitle" name="title" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignmentTemplate" class="form-label">Plantilla de Tarea *</label>
                                <select class="form-select" id="assignmentTemplate" name="taskTemplateId" required>
                                    <option value="">Selecciona una plantilla...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignmentUser" class="form-label">Asignar a Usuario *</label>
                                <select class="form-select" id="assignmentUser" name="assignedToUserId" required>
                                    <option value="">Selecciona un usuario...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Specialist selector removed -->
                            
                            <div class="mb-3">
                                <label for="assignmentStartDate" class="form-label">Fecha de Inicio *</label>
                                <input type="date" class="form-control" id="assignmentStartDate" name="startDate" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="assignmentDueDate" class="form-label">Fecha Límite</label>
                                <input type="date" class="form-control" id="assignmentDueDate" name="dueDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assignmentDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="assignmentDescription" name="description" rows="3" 
                                  placeholder="Describe los objetivos de esta asignación..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Crear Asignación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    loadAssignments();
    loadFormData();
    
    $('#assignmentForm').on('submit', function(e) {
        e.preventDefault();
        createAssignment();
    });
    
    // Set default start date to today
    $('#assignmentStartDate').val(new Date().toISOString().split('T')[0]);
});

function loadAssignments() {
    // Load all assignments for admin view - updated to use new endpoint
    const tbody = $('#assignmentsTable tbody');
    tbody.html(`
        <tr>
            <td colspan="7" class="text-center">
                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
            </td>
        </tr>
    `);
    
    $.ajax({
        url: '/api/assignments',
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                tbody.empty();
                if (response.data.length === 0) {
                    tbody.html(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>No hay asignaciones registradas
                            </td>
                        </tr>
                    `);
                } else {
                    response.data.forEach(function(assignment) {
                        const startDate = new Date(assignment.startDate).toLocaleDateString();
                        const dueDate = assignment.dueDate ? new Date(assignment.dueDate).toLocaleDateString() : 'Sin fecha límite';
                        // Specialist removed
                        
                        const row = `
                            <tr>
                                <td><strong>${assignment.title}</strong></td>
                                <td>${assignment.assignedToUserName}</td>
                                <td>${assignment.taskTemplateName}</td>
                                <!-- Specialist column removed -->
                                <td>${startDate}</td>
                                <td>${dueDate}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal(${assignment.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAssignment(${assignment.id})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                }
            } else {
                tbody.html(`
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar las asignaciones
                        </td>
                    </tr>
                `);
            }
        },
        error: function() {
            tbody.html(`
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar las asignaciones
                    </td>
                </tr>
            `);
        }
    });
}

function loadFormData() {
    // Load task templates
    $.ajax({
        url: '/api/tasks/templates',
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                const select = $('#assignmentTemplate');
                select.html('<option value="">Selecciona una plantilla...</option>');
                response.data.filter(t => t.active).forEach(function(template) {
                    select.append(`<option value="${template.id}">${template.name}</option>`);
                });
            }
        }
    });
    
    // Specialist loading removed - assignments now use users directly
    
    // Load users (in a real app, you'd have a dedicated endpoint for this)
    // For now, we'll add some static options based on our sample data
    const userSelect = $('#assignmentUser');
    userSelect.html(`
        <option value="">Selecciona un usuario...</option>
        <option value="2">Juan Pérez</option>
        <option value="3">María González</option>
        <option value="4">Carlos Rodríguez</option>
    `);
}

function openCreateModal() {
    $('#assignmentForm')[0].reset();
    $('#assignmentStartDate').val(new Date().toISOString().split('T')[0]);
    loadFormData();
}

function createAssignment() {
    const data = {
        taskTemplateId: parseInt($('#assignmentTemplate').val()),
        title: $('#assignmentTitle').val(),
        description: $('#assignmentDescription').val() || null,
        assignedToUserId: parseInt($('#assignmentUser').val()),
        // specialistId removed - assignments now directly use users
        startDate: $('#assignmentStartDate').val(),
        dueDate: $('#assignmentDueDate').val() || null
    };
    
    // Validation
    if (!data.taskTemplateId || !data.title.trim() || !data.assignedToUserId || !data.startDate) {
        alert('Por favor completa todos los campos obligatorios');
        return;
    }
    
    // Disable submit button
    const submitBtn = $('#assignmentForm button[type="submit"]');
    const originalText = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Creando...');
    
    $.ajax({
        url: '/api/assignments',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                $('#assignmentModal').modal('hide');
                loadAssignments();
                showSuccess(response.message);
            } else {
                showError(response.message);
            }
            submitBtn.prop('disabled', false).html(originalText);
        },
        error: function() {
            showError('Error al crear la asignación');
            submitBtn.prop('disabled', false).html(originalText);
        }
    });
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}

function showAlert(message, type) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('.border-bottom').after(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);
}

// Edit and delete functions - added for admin assignment management
function openEditModal(id) {
    // TODO: Implement edit functionality in future enhancement
    showError('La funcionalidad de edición estará disponible en una próxima actualización');
}

function deleteAssignment(id) {
    if (!confirm('¿Está seguro de que desea eliminar esta asignación? Esta acción no se puede deshacer.')) {
        return;
    }
    
    $.ajax({
        url: `/api/assignments/${id}`,
        type: 'DELETE',
        success: function(response) {
            if (response.success) {
                loadAssignments();
                showSuccess(response.message);
            } else {
                showError(response.message);
            }
        },
        error: function() {
            showError('Error al eliminar la asignación');
        }
    });
}
</script>
}